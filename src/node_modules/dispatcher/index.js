'use strict';

var Dispatcher = require('flux').Dispatcher;

var io = require('socket.io');
var utils = require('utils');

if(utils.isBrowser()) {
  io = io.connect('localhost:9005');
} else {
  io = io.listen(9005);
}

var appDispatcher = new Dispatcher();

appDispatcher.handleUserAction = (action) => {
  var payload = {
    source: 'VIEW_ACTION',
    action: action
  };

  this.dispatch(payload);

  io.emit('action', payload);
};

appDispatcher.dispatch = appDispatcher.dispatch.bind(appDispatcher);

io.on('connect', (socket) => {
  socket = socket || io;

  socket.on('action', function(payload) {
    appDispatcher.dispatch(payload);

    if(!utils.isBrowser()) {
      socket.broadcast.emit('action', payload);
    }
  });
});

module.exports = appDispatcher;
